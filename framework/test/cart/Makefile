# ------------------------------------------------------------------------------
# Common
# ------------------------------------------------------------------------------

include ../../common.mk

# ------------------------------------------------------------------------------
# Paths
# ------------------------------------------------------------------------------

OUT_PATH             := out
SRC_PATH             := src
INCLUDE_PATH         := ../../include
FRAMEWORK_PATH       := ../../out
BUILD_PATH           := $(OUT_PATH)/build

OUT_PATH_EXISTS      := $(wildcard $(OUT_PATH))

# ------------------------------------------------------------------------------
# Tool flags
# ------------------------------------------------------------------------------

VASM_FLAGS           := $(VASM_FLAGS) -I$(INCLUDE_PATH) -I$(FRAMEWORK_PATH)
MKASMDEP_FLAGS       := $(MKASMDEP_FLAGS) -i $(INCLUDE_PATH) -i $(FRAMEWORK_PATH)

# ------------------------------------------------------------------------------
# Files
# ------------------------------------------------------------------------------

SRC                  := $(wildcard $(SRC_PATH)/*.asm)
OBJ                  := $(patsubst $(SRC_PATH)/%.asm,$(BUILD_PATH)/%.o,$(SRC))
DEPEND               := $(patsubst %.o,%.d,$(OBJ))

OUT                  := $(OUT_PATH)/mcd_cart_test.gen

LINKER               := linker.link

# ------------------------------------------------------------------------------
# Reserved rules
# ------------------------------------------------------------------------------

.PHONY: all clean framework

# ------------------------------------------------------------------------------
# Make all
# ------------------------------------------------------------------------------

all: $(OUT)

# ------------------------------------------------------------------------------
# Clean
# ------------------------------------------------------------------------------

clean:
ifneq ($(OUT_PATH_EXISTS),)
	@rmdir /s /q "$(OUT_PATH)"
endif

# ------------------------------------------------------------------------------
# Rules
# ------------------------------------------------------------------------------

$(OUT): $(OBJ) | $(OUT_PATH)
	$(LINK_MSG)
	@$(VLINK) $(VLINK_FLAGS) -T $(LINKER) -o $@ $^
	@$(MDROMFIX) -q $@

$(OBJ): $(BUILD_PATH)/%.o: $(SRC_PATH)/%.asm | $(BUILD_PATH) $(DEPEND)
	$(ASSEMBLE_MSG)
	@$(VASM) $(VASM_FLAGS) -DUSE_MCD_MODE_1=1 -L $(patsubst %.o,%.lst,$@) -o $@ $<

$(DEPEND): $(BUILD_PATH)/%.d: $(SRC_PATH)/%.asm | $(BUILD_PATH) framework
	$(DEPEND_MSG)
	@$(MKASMDEP) $(MKASMDEP_FLAGS) -o $@ $(patsubst %.d,%.o,$@) $<

framework:
	make -C ../..

# ------------------------------------------------------------------------------
# Path rules
# ------------------------------------------------------------------------------

$(OUT_PATH):
	@mkdir "$@"

$(BUILD_PATH):
	@mkdir "$@"

# ------------------------------------------------------------------------------
# Dependencies
# ------------------------------------------------------------------------------

ifneq (clean,$(filter clean,$(MAKECMDGOALS)))
-include $(DEPEND)
endif

# ------------------------------------------------------------------------------